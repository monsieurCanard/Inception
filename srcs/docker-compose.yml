version: "3.7"

services:
  mariadb:
    container_name: mariadb
    build:
     context: ./requirements/mariadb
    environment:
      - MY_SQL_ROOT_PASSWORD_FILE=/run/secrets/root_password
      - MY_SQL_USER_FILE=/run/secrets/sql_user
      - MY_SQL_PASSWORD_FILE=/run/secrets/password
      - DB_NAME_FILE=/run/secrets/sql_db_name
    secrets:
      - root_password
      - password
      - sql_user
      - sql_db_name
    volumes:
      - db:/var/lib/mysql
    networks:
      - app-network
    restart: on-failure

  wordpress:
    container_name: wordpress
    build: ./requirements/wordpress
    environment:
      - WORDPRESS_DB_HOST_FILE=/run/secrets/wp_db_host
      - WORDPRESS_DB_USER_FILE=/run/secrets/wp_db_user
      - WORDPRESS_DB_PASSWORD_FILE=/run/secrets/password
      - WORDPRESS_DB_NAME_FILE=/run/secrets/wp_db_name
      - WORDPRESS_URL_FILE=/run/secrets/wp_url
      - WORDPRESS_TITLE_FILE=/run/secrets/wp_title
      - WORDPRESS_ADMIN_USER_FILE=/run/secrets/wp_admin_user
      - WORDPRESS_ADMIN_PASSWORD_FILE=/run/secrets/wp_admin_password
      - WORDPRESS_ADMIN_EMAIL_FILE=/run/secrets/wp_admin_email
    secrets:
      - wp_db_host
      - wp_db_user
      - password
      - wp_db_name
      - wp_url
      - wp_title
      - wp_admin_user
      - wp_admin_password
      - wp_admin_email
    depends_on:
      - mariadb
      - redis
    volumes:
      - wp:/var/www/html
    networks:
      - app-network
    restart: on-failure

  nginx:
    container_name: nginx
    build: ./requirements/nginx
    ports:
      - "443:443"
    depends_on:
      - wordpress
    volumes:
      - wp:/var/www/html
    networks:
      - app-network
    restart: on-failure

  adminer:
    container_name: adminer
    build: ./bonus/adminer
    depends_on:
      - mariadb
    volumes:
      - wp:/var/www/html
    networks:
      - app-network
    restart: on-failure

  ftp_server:
    container_name: ftp_server
    build: ./bonus/ftp_server
    environment:
      - FTP_PASSWORD=/run/secrets/root_password
      - FTP_USER=/run/secrets/sql_user
    secrets:
      - root_password
      - sql_user
    depends_on:
      - wordpress
    ports:
      - "21:21"
    volumes:
      - wp:/var/www/html
    networks:
      - app-network
    restart: on-failure
  
  redis:
    container_name: redis
    build: ./bonus/redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/var/lib/redis
    networks:
      - app-network
    restart: on-failure

networks:
  app-network:
    name: app-network
    driver: bridge

volumes:
  wp:
    driver: local
    name: wp
    driver_opts:
      type: none
      o: bind
      device: /home/antgabri/data/wordpress
  db:
    driver: local
    name: db
    driver_opts:
      type: none
      o: bind
      device: /home/antgabri/data/mariadb

  redis-data:
    driver: local
    name: redis-data
    driver_opts:
      type: none
      o: bind
      device: /home/antgabri/data/redis

secrets:
  root_password:
    file: ${ROOT_PASSWORD}
  password:
    file: ${PASSWORD}
  wp_admin_password:
    file: ${WP_ADMIN_PASSWORD}
  sql_user:
    file: ${SQL_USER}
  sql_db_name:
    file: ${SQL_DB_NAME}
  wp_db_host:
    file: ${WP_DB_HOST}
  wp_db_user:
    file: ${WP_DB_USER}
  wp_db_name:
    file: ${WP_DB_NAME}
  wp_url:
    file: ${WP_URL}
  wp_title:
    file: ${WP_TITLE}
  wp_admin_user:
    file: ${WP_ADMIN_USER}
  wp_admin_email:
    file: ${WP_ADMIN_EMAIL}